<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Home Finance Dashboard — v4 Final (UI + Firebase)</title>

<link href="style.css" rel="stylesheet" />

<!-- Chart.js (used for demo charts) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>
  <div class="app">

    <header class="topbar">
      <div class="brand"><div class="badge">HF</div><div class="title">Home Finance Dashboard</div></div>
      <div class="user">Logged: Single User</div>
    </header>

    <main class="container">
      <section class="summary-cards">
        <div class="card"> <div class="label">Total Saving</div><div id="totalSaving" class="value">₹0</div></div>
        <div class="card"> <div class="label">Total Expense</div><div id="totalExpense" class="value">₹0</div></div>
        <div class="card"> <div class="label">Trading Amount</div><div id="totalTrading" class="value">₹0</div></div>
        <div class="card"> <div class="label">Long Term Investment</div><div id="totalInvest" class="value">₹0</div></div>
        <div class="card"> <div class="label">Pending Udhaar</div><div id="totalPending" class="value">₹0</div></div>
      </section>

      <div class="addbar">
        <button id="openAdd" class="btn-primary">+ Add Entry</button>
        <div class="searchwrap"><input id="globalSearch" placeholder="Search transactions / product / person" /></div>
      </div>

      <section class="grid">
        <div class="charts panel">
          <div class="panel-title">Expense Breakdown & Overview</div>
          <div class="charts-inner">
            <canvas id="pieChart"></canvas>
            <canvas id="barChart"></canvas>
          </div>
        </div>

        <aside class="rightcol">
          <div class="panel accounts">
            <div class="panel-title">Accounts Summary <button id="addAccountBtn" class="small">+ Add</button></div>
            <div id="accountsList"></div>
          </div>

          <div class="panel pending">
            <div class="panel-title">Pending Udhaar</div>
            <div id="pendingList">No pending</div>
          </div>
        </aside>
      </section>

      <section class="recent panel full">
        <div class="panel-title">Recent Entries</div>
        <table class="tx-table">
          <thead><tr><th>Date</th><th>Type</th><th>Account</th><th>Product</th><th>Amount</th></tr></thead>
          <tbody id="txBody"></tbody>
        </table>
      </section>
    </main>

    <!-- Add Entry Modal -->
    <div id="modal" class="modal hidden" role="dialog" aria-hidden="true">
      <div class="modal-inner">
        <div class="modal-head">
          <h3>Add Entry</h3>
          <button id="closeModal" class="close">✕</button>
        </div>
        <form id="entryForm" class="modal-body">
          <div class="row">
            <label>Date <input id="fldDate" type="date" /></label>
            <label>Type <select id="fldType"><option>Credit</option><option>Debit</option></select></label>
          </div>

          <div class="row">
            <label>Account
              <div class="inline">
                <select id="fldAccount"><option value="">No accounts - create one (+)</option></select>
                <button id="fldAccountAdd" type="button" class="small">+</button>
              </div>
            </label>
            <label>Amount (₹) <input id="fldAmount" type="number" /></label>
          </div>

          <div class="row">
            <label>Product <input id="fldProduct" list="prodList" placeholder="Product / Category" /></label>
            <label>Quantity <input id="fldQty" placeholder="Qty" /></label>
            <datalist id="prodList"></datalist>
          </div>

          <div class="row">
            <label>For <input id="fldFor" placeholder="For whom" list="personList" /></label>
            <label>By <input id="fldBy" placeholder="By whom (who brought)" list="personList" /></label>
            <datalist id="personList"></datalist>
          </div>

          <div class="row full">
            <label>From (source) <input id="fldFrom" placeholder="From which account or source" /></label>
          </div>

          <div class="row full">
            <label>Note <textarea id="fldNote" placeholder="Optional details..."></textarea></label>
          </div>

          <div class="row">
            <label class="checkbox"><input id="fldUnpaid" type="checkbox" /> Mark as Unpaid (Pending Udhaar)</label>
          </div>

          <div class="row full custom-area">
            <div class="custom-title">Custom fields for account</div>
            <div class="custom-controls">
              <input id="customLabel" placeholder="Field label (e.g. Receipt #)" />
              <button id="addFieldBtn" type="button" class="small">Add field</button>
            </div>
            <div id="customFields"></div>
          </div>

          <div class="actions">
            <button type="button" id="saveBtn" class="btn-primary">Save</button>
            <button type="button" id="cancelBtn" class="btn-ghost">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="foot">UI-only demo — v4 Final</footer>
  </div>

<script>
// ------------------------
// Firebase config - replace if needed (your project)
const firebaseConfig = {
  apiKey: "AIzaSyCZ_eQonlY2OxSyJt55Efjr8TH1BYGIQ-Q",
  authDomain: "house-expense-a4c13.firebaseapp.com",
  projectId: "house-expense-a4c13"
};
// Initialize
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// local helpers
const $ = (id) => document.getElementById(id);

// UI refs
const modal = $('modal');
const openAdd = $('openAdd');
const closeModal = $('closeModal');
const saveBtn = $('saveBtn');
const cancelBtn = $('cancelBtn');
const fldDate = $('fldDate');
const fldType = $('fldType');
const fldAccount = $('fldAccount');
const fldAccountAdd = $('fldAccountAdd');
const fldAmount = $('fldAmount');
const fldProduct = $('fldProduct');
const prodList = $('prodList');
const fldQty = $('fldQty');
const fldFor = $('fldFor');
const fldBy = $('fldBy');
const personList = $('personList');
const fldFrom = $('fldFrom');
const fldNote = $('fldNote');
const fldUnpaid = $('fldUnpaid');
const customFields = $('customFields');
const addFieldBtn = $('addFieldBtn');
const customLabel = $('customLabel');
const accountsList = $('accountsList');
const txBody = $('txBody');
const totalSaving = $('totalSaving');
const totalExpense = $('totalExpense');
const totalTrading = $('totalTrading');
const totalInvest = $('totalInvest');
const totalPending = $('totalPending');

// state
let accounts = []; // {id, name, customFields: [{label, valueKey}], balance}
let productsSet = new Set();
let personsSet = new Set();

// default date
fldDate.value = new Date().toISOString().slice(0,10);

// open/close modal
openAdd.addEventListener('click', ()=>{ showModal(); });
closeModal.addEventListener('click', hideModal);
cancelBtn.addEventListener('click', hideModal);

function showModal(){ modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
function hideModal(){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); clearForm(); }

// clear form
function clearForm(){
  fldAmount.value=''; fldProduct.value=''; fldQty.value=''; fldFor.value=''; fldBy.value=''; fldFrom.value=''; fldNote.value=''; fldUnpaid.checked=false;
  customFields.innerHTML=''; customLabel.value='';
}

// load initial data (accounts + transactions)
async function loadInitial(){
  // load accounts
  const accSnap = await db.collection('accounts').get().catch(()=>({empty:true}));
  if(!accSnap.empty){
    accSnap.forEach(d=>{
      const r = d.data(); r.id = d.id; accounts.push(r);
    });
  } else {
    // create default accounts locally if none
    accounts = [
      {id:'acc_daddy', name:'Daddy Budget', balance:11850, customFields:[]},
      {id:'acc_me', name:'My Account', balance:9500, customFields:[]},
      {id:'acc_mata', name:'Mataji Account', balance:21000, customFields:[]},
      {id:'acc_cash', name:'Cash', balance:0, customFields:[]}
    ];
  }
  renderAccounts();
  // load transactions (limit 50)
  const txSnap = await db.collection('transactions').orderBy('createdAt','desc').limit(50).get().catch(()=>({empty:true}));
  let txs = [];
  if(!txSnap.empty){
    txSnap.forEach(d=>{
      const t = d.data(); t.id = d.id; txs.push(t);
      if(t.product) productsSet.add(t.product);
      if(t.for) personsSet.add(t.for);
      if(t.by) personsSet.add(t.by);
    });
  } else {
    // demo entries
    txs = [
      {date:'2025-11-01', type:'Credit', account:'Daddy Budget', product:'Daddy Fund', amount:20000},
      {date:'2025-11-03', type:'Debit', account:'Daddy Budget', product:'Rent', amount:8000},
      {date:'2025-11-05', type:'Debit', account:'Daddy Budget', product:'Milk', amount:150}
    ];
  }
  renderTransactions(txs);
  populateSuggestionLists();
  updateTotals(txs);
}

// render accounts list + dropdown
function renderAccounts(){
  accountsList.innerHTML='';
  fldAccount.innerHTML = '';
  accounts.forEach(a=>{
    const div = document.createElement('div'); div.className='acc-row';
    div.innerHTML = `<div class="acc-name">${a.name}</div><div class="acc-bal">₹${a.balance||0}</div>`;
    accountsList.appendChild(div);
    const opt = document.createElement('option'); opt.value = a.name; opt.textContent = a.name; fldAccount.appendChild(opt);
  });
}

// add account button (opens small prompt to create account)
fldAccountAdd.addEventListener('click', ()=>{
  const name = prompt('Enter new account name (example: HDFC Credit Card)');
  if(!name) return;
  const acc = {id:'local_'+Date.now(), name, balance:0, customFields:[]};
  accounts.push(acc);
  // Save to firestore accounts collection
  db.collection('accounts').add(acc).catch(()=>console.log('account save failed (offline)'));
  renderAccounts();
  alert('Account created: '+name);
});

// transactions render
function renderTransactions(txs){
  txBody.innerHTML='';
  txs.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.date||t.createdAt?.toDate?.().toLocaleDateString()||''}</td><td>${t.type||''}</td><td>${t.account||''}</td><td>${t.product||''}</td><td>₹${t.amount||0}</td>`;
    txBody.appendChild(tr);
  });
}

// add custom field UI
addFieldBtn.addEventListener('click', ()=>{
  const label = customLabel.value.trim(); if(!label) return alert('Enter a label');
  const key = 'f_' + label.toLowerCase().replace(/\s+/g,'_') + '_' + Date.now();
  const row = document.createElement('div'); row.className='custom-row';
  row.innerHTML = `<label>${label} <input data-key="${key}" placeholder="${label}" /></label> <button class="small remove">Remove</button>`;
  customFields.appendChild(row);
  row.querySelector('.remove').addEventListener('click', ()=>row.remove());
  customLabel.value='';
});

// Save entry
saveBtn.addEventListener('click', async ()=>{
  const doc = {
    date: fldDate.value,
    type: fldType.value,
    account: fldAccount.value,
    amount: Number(fldAmount.value||0),
    product: fldProduct.value.trim(),
    qty: fldQty.value.trim(),
    for: fldFor.value.trim(),
    by: fldBy.value.trim(),
    from: fldFrom.value.trim(),
    note: fldNote.value.trim(),
    unpaid: fldUnpaid.checked,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  // collect custom fields
  const cfields = {};
  customFields.querySelectorAll('[data-key]').forEach(inp=>{
    cfields[inp.getAttribute('data-key')] = inp.value;
  });
  if(Object.keys(cfields).length) doc.custom = cfields;
  // push to firestore
  try{
    await db.collection('transactions').add(doc);
    alert('Saved to Firestore (or queued).');
  }catch(e){
    // fallback localStorage
    const arr = JSON.parse(localStorage.getItem('tx_offline')||'[]');
    arr.push(doc); localStorage.setItem('tx_offline', JSON.stringify(arr));
    alert('Saved locally (offline).');
  }
  hideModal();
  // refresh simple UI (append)
  renderTransactions([doc, ...Array.from(txBody.querySelectorAll('tr')).map(tr=>{
    const td = tr.querySelectorAll('td');
    return {date:td[0].innerText, type:td[1].innerText, account:td[2].innerText, product:td[3].innerText, amount:td[4].innerText.replace('₹','')};
  })]);
  // update suggestions and totals
  if(doc.product) productsSet.add(doc.product);
  if(doc.for) personsSet.add(doc.for);
  populateSuggestionLists();
});

// search suggestions lists
function populateSuggestionLists(){
  prodList.innerHTML='';
  personList.innerHTML='';
  Array.from(productsSet).forEach(p=> prodList.insertAdjacentHTML('beforeend', `<option value="${p}">`));
  Array.from(personsSet).forEach(p=> personList.insertAdjacentHTML('beforeend', `<option value="${p}">`));
}

// update totals simple demo
function updateTotals(txs){
  let saving=0, expense=0, trading=0, invest=0, pending=0;
  txs.forEach(t=>{
    const amt = Number(t.amount||0);
    if(t.type && t.type.toLowerCase()==='credit') saving += amt;
    else expense += amt;
  });
  totalSaving.innerText = '₹'+saving;
  totalExpense.innerText = '₹'+expense;
  totalTrading.innerText = '₹'+trading;
  totalInvest.innerText = '₹'+invest;
  totalPending.innerText = '₹'+pending;
}

// basic charts (demo)
function initCharts(){
  const pie = new Chart(document.getElementById('pieChart'),{type:'pie',data:{labels:['Rent','Food','Trading','Other'], datasets:[{data:[40,25,25,10]}]}});
  const bar = new Chart(document.getElementById('barChart'),{type:'bar',data:{labels:['Saving','Expense','Trading','Investment'], datasets:[{label:'Amount',data:[40000,18000,12000,5000]}]}});
}

// init
initCharts();
loadInitial();

// search filtering
$('globalSearch').addEventListener('input', async function(e){
  const q = e.target.value.trim().toLowerCase();
  if(!q){ loadInitial(); return; }
  const snap = await db.collection('transactions').orderBy('createdAt','desc').limit(200).get().catch(()=>({empty:true}));
  const results = [];
  if(!snap.empty){
    snap.forEach(d=>{
      const r = d.data();
      const hay = `${r.product||''} ${r.for||''} ${r.by||''} ${r.note||''}`.toLowerCase();
      if(hay.includes(q)) results.push(r);
    });
  }
  renderTransactions(results);
});

// close modal on ESC
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideModal(); });

</script>
</body>
</html>
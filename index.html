<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ultimate Finance Dashboard Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #2563eb; 
    --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --border: #e2e8f0; --radius: 12px;
  }
  body { margin:0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 15px; }
  .app { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 280px 1fr 320px; gap: 20px; display:none; }
  
  aside .card { height: 92vh; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
  .config-section { margin-bottom: 25px; }
  .config-section p { margin: 0 0 10px 0; font-size: 14px; font-weight: 700; color: #64748b; border-bottom: 2px solid var(--bg); padding-bottom: 5px; }
  .config-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; font-size: 13px; border: 1px solid var(--border); }
  .btn-del-sm { background: #fee2e2; color: #ef4444; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }

  .stats-header { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
  .runway-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 20px; border-radius: var(--radius); }
  .runway-val { font-size: 32px; font-weight: 800; color: #fbbf24; margin: 5px 0; }
  .runway-bar-bg { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px; }
  .runway-bar-fill { height: 100%; background: #fbbf24; border-radius: 10px; transition: 1s; width: 0%; }

  .health-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
  .score-circle { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 800; border: 5px solid #e2e8f0; margin-bottom: 8px; transition: 0.5s; }
  .score-label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }

  #walletGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .w-card { background: var(--card); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); }
  .w-val { font-size: 18px; font-weight: 800; color: var(--primary); }
  .card { background: var(--card); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
  
  input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 12px; font-size: 13px; box-sizing: border-box; }
  label { font-size: 11px; font-weight: 800; color: #64748b; margin-bottom: 4px; display: block; }
  
  .btn { cursor: pointer; padding: 10px; border-radius: 8px; border: none; font-weight: 700; width: 100%; }
  .btn-save { background: var(--success); color: white; font-size: 16px; margin-top: 10px; height: 45px; }
  
  .row-credit { border-left: 5px solid var(--success); background: #f0fdf4 !important; }
  .row-debit { border-left: 5px solid var(--danger); background: #fef2f2 !important; }
  .row-transfer { border-left: 5px solid var(--warning); background: #fffbeb !important; }

  #loader { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; }
  table { width: 100%; border-collapse: collapse; font-size: 11px; }
  th { text-align: left; padding: 10px; background: #f8fafc; color: #64748b; border-bottom: 2px solid var(--border); }
  td { padding: 10px; border-bottom: 1px solid var(--border); }
</style>
</head>
<body>

<div id="loader">üöÄ Powering Up Your Financial Brain...</div>

<div class="app" id="mainApp">
  <aside>
    <div class="card">
      <h2 style="color:var(--primary); margin:0 0 20px 0; font-size: 18px;">‚öôÔ∏è Settings</h2>
      <div class="config-section">
        <p>WALLETS</p>
        <div id="accList"></div>
        <input id="newAccName" placeholder="Bank or Wallet">
        <button class="btn" style="background:var(--primary); color:white" onclick="addItem('accounts', 'newAccName')">+ Add Wallet</button>
      </div>
    </div>
  </aside>

  <div class="main">
    <div class="stats-header">
      <div class="runway-card">
        <div style="font-size: 11px; opacity: 0.8; letter-spacing: 1px;">SURVIVAL RUNWAY</div>
        <div class="runway-val" id="runwayValue">Analyzing...</div>
        <div id="runwayDetail" style="font-size: 11px; opacity: 0.7;">Waiting...</div>
        <div class="runway-bar-bg"><div class="runway-bar-fill" id="runwayBar"></div></div>
      </div>
      <div class="health-card">
        <div class="score-label">Health Score</div>
        <div class="score-circle" id="scoreCircle">--</div>
        <div id="scoreStatus" style="font-size: 13px; font-weight: 700; color: #64748b;">Waiting...</div>
      </div>
    </div>

    <div id="walletGrid"></div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <div class="card" style="height: 180px; margin:0;"><canvas id="barChart"></canvas></div>
      <div class="card" style="height: 180px; margin:0;"><canvas id="pieChart"></canvas></div>
      <div class="card" style="height: 180px; margin:0;"><canvas id="growthChart"></canvas></div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>History</h3>
        <input id="searchInp" placeholder="üîç Search records..." oninput="renderHistory()" style="width:180px; margin:0;">
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Wallet</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Amount</th>
              <th>From / By / For</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="right-col">
    <div class="card">
      <h3 style="margin-top:0; color:var(--primary);">Entry Form</h3>
      
      <label>DATE</label>
      <input type="date" id="f_Date">

      <label>AMOUNT</label>
      <input type="number" id="f_Amount" placeholder="‚Çπ 0.00">

      <label>PRODUCT</label>
      <input type="text" id="f_Product" list="productSuggestions" placeholder="Product Name">
      <datalist id="productSuggestions"></datalist>

      <label>QUANTITY</label>
      <input type="text" id="f_Quantity" placeholder="Quantity">

      <label>BY</label>
      <input type="text" id="f_By" placeholder="BY">

      <label>FROM</label>
      <input type="text" id="f_From" placeholder="Source">

      <label>FOR</label>
      <input type="text" id="f_For" placeholder="Purpose">

      <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">

      <label>TRANSACTION TYPE</label>
      <select id="txType" onchange="toggleForm()">
        <option value="Debit">‚ûñ DEBIT (Expense)</option>
        <option value="Credit">‚ûï CREDIT (Income)</option>
        <option value="Transfer">üîÑ TRANSFER</option>
      </select>

      <div id="normalAcc">
        <label>WALLET</label>
        <select id="accSelect"></select>
      </div>

      <div id="transferAcc" style="display:none; background:#fffbeb; padding:10px; border-radius:8px; margin-bottom:12px;">
        <label>From Wallet</label><select id="accFrom"></select>
        <label>To Wallet</label><select id="accTo"></select>
      </div>

      <button class="btn btn-save" onclick="saveTransaction()">Save Record</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwjwSeS7svH3Rz_bQ6kfTrvw3oJIgGOy2m_saj_0TmoU6zkSUpk7mZI60aPsYtwmAIO/exec"; 
let CLOUD_DATA = { accounts:[], txs:[] };
let charts = { bar: null, pie: null, growth: null };

async function init() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    for(let k in data) { try { CLOUD_DATA[k] = JSON.parse(data[k]); } catch(e) { CLOUD_DATA[k] = data[k]; } }
    
    if(!CLOUD_DATA.accounts || CLOUD_DATA.accounts.length === 0) {
      CLOUD_DATA.accounts = ['Cash', 'Main Bank'];
      CLOUD_DATA.txs = [];
    }

    setDefaultDate();
    refreshUI();
    document.getElementById('loader').style.display = 'none';
    document.getElementById('mainApp').style.display = 'grid';
  } catch(e) { alert("Check API Connection."); }
}

function setDefaultDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('f_Date').value = today;
}

async function sync(key, value) {
  CLOUD_DATA[key] = value;
  await fetch(API_URL, { method:'POST', body:JSON.stringify({key, data:JSON.stringify(value)}) });
}

// Function to update suggestions based on history
function updateSuggestions() {
    const datalist = document.getElementById('productSuggestions');
    const uniqueProducts = [...new Set(CLOUD_DATA.txs.map(t => t.Product).filter(p => p))];
    datalist.innerHTML = uniqueProducts.map(p => `<option value="${p}">`).join('');
}

function updateHealthAndRunway(netWorth, txs) {
  const debits = txs.filter(t => t._type === 'Debit' && t.Amount).sort((a,b)=> new Date(b.Date) - new Date(a.Date));
  const credits = txs.filter(t => t._type === 'Credit' && t.Amount);
  
  let score = 0; let runwayDays = 0;

  if (debits.length >= 2 && netWorth > 0) {
    const totalD = debits.reduce((s, t) => s + parseFloat(t.Amount), 0);
    const daysRange = Math.max(1, (new Date(debits[0].Date) - new Date(debits[debits.length-1].Date)) / 86400000);
    const dailyBurn = totalD / daysRange;
    runwayDays = Math.round(netWorth / dailyBurn);

    const val = document.getElementById('runwayValue');
    const bar = document.getElementById('runwayBar');
    if(runwayDays > 365) { val.innerText = (runwayDays/365).toFixed(1) + " Years"; bar.style.width="100%"; bar.style.backgroundColor="#10b981"; score += 50; }
    else if(runwayDays > 30) { val.innerText = (runwayDays/30).toFixed(1) + " Months"; bar.style.width="60%"; bar.style.backgroundColor="#fbbf24"; score += 30; }
    else { val.innerText = runwayDays + " Days"; bar.style.width="20%"; bar.style.backgroundColor="#ef4444"; score += 10; }
    document.getElementById('runwayDetail').innerText = `Daily Burn: ‚Çπ${Math.round(dailyBurn)}`;
  }

  const totalIncome = credits.reduce((s, t) => s + parseFloat(t.Amount), 0);
  const totalExpense = debits.reduce((s, t) => s + parseFloat(t.Amount), 0);
  if(totalIncome > 0) {
    const savingsRate = ((totalIncome - totalExpense) / totalIncome) * 100;
    if(savingsRate > 40) score += 50; else if(savingsRate > 20) score += 30; else if(savingsRate > 0) score += 10;
  }

  const circle = document.getElementById('scoreCircle');
  const status = document.getElementById('scoreStatus');
  circle.innerText = score;
  if(score >= 80) { circle.style.borderColor = "#10b981"; status.innerText = "EXCELLENT"; status.style.color="#10b981"; }
  else if(score >= 40) { circle.style.borderColor = "#fbbf24"; status.innerText = "GOOD"; status.style.color="#fbbf24"; }
  else { circle.style.borderColor = "#ef4444"; status.innerText = "CRITICAL"; status.style.color="#ef4444"; }
}

function renderWallets() {
  const grid = document.getElementById('walletGrid'); grid.innerHTML = '';
  let bals = {}; let tC=0, tD=0, net=0, monthMap={};
  CLOUD_DATA.accounts.forEach(a => bals[a] = 0);
  CLOUD_DATA.txs.forEach(t => {
    const amt = parseFloat(t.Amount) || 0;
    const m = (t.Date || '2025-01').slice(0,7);
    if(!monthMap[m]) monthMap[m] = {c:0, d:0};
    if(t._type==='Credit'){ bals[t._acc]+=amt; tC+=amt; monthMap[m].c+=amt; }
    else if(t._type==='Debit'){ bals[t._acc]-=amt; tD+=amt; monthMap[m].d+=amt; }
    else if(t._type==='Transfer'){ bals[t._accFrom]-=amt; bals[t._accTo]+=amt; }
  });
  for(let a in bals) { net += bals[a]; grid.innerHTML += `<div class="w-card"><div style="font-size:10px;font-weight:700;color:#64748b">${a}</div><div class="w-val">‚Çπ${bals[a].toLocaleString()}</div></div>`; }
  updateHealthAndRunway(net, CLOUD_DATA.txs);
  updateCharts(monthMap, tC, tD);
}

function toggleForm() {
  const type = document.getElementById('txType').value;
  document.getElementById('normalAcc').style.display = type==='Transfer'?'none':'block';
  document.getElementById('transferAcc').style.display = type==='Transfer'?'block':'none';
}

async function saveTransaction() {
  const type = document.getElementById('txType').value;
  let entry = { 
    id: Date.now(), 
    _type: type,
    Date: document.getElementById('f_Date').value,
    Amount: document.getElementById('f_Amount').value,
    Product: document.getElementById('f_Product').value,
    Quantity: document.getElementById('f_Quantity').value,
    By: document.getElementById('f_By').value,
    From: document.getElementById('f_From').value,
    For: document.getElementById('f_For').value
  };

  if(type==='Transfer') { 
    entry._accFrom = document.getElementById('accFrom').value; 
    entry._accTo = document.getElementById('accTo').value; 
    entry._acc = entry._accFrom;
  } else { 
    entry._acc = document.getElementById('accSelect').value; 
  }

  if(!entry.Amount || !entry.Date) return alert("Fill Amount & Date!");

  CLOUD_DATA.txs.unshift(entry); 
  await sync('txs', CLOUD_DATA.txs);
  
  ['f_Amount', 'f_Product', 'f_Quantity', 'f_By', 'f_From', 'f_For'].forEach(id => {
      document.getElementById(id).value = '';
  });
  
  refreshUI();
}

function renderHistory() {
  const search = document.getElementById('searchInp').value.toLowerCase();
  const body = document.getElementById('txBody'); body.innerHTML = '';
  
  CLOUD_DATA.txs.forEach(t => {
    const searchStr = `${t.Date} ${t._type} ${t._acc} ${t.Product} ${t.By} ${t.From} ${t.For}`.toLowerCase();
    if(searchStr.includes(search)) {
      const rowClass = t._type==='Credit'?'row-credit':(t._type==='Debit'?'row-debit':'row-transfer');
      const accDisplay = t._type==='Transfer' ? `${t._accFrom} ‚ûî ${t._accTo}` : t._acc;
      
      body.innerHTML += `
        <tr class="${rowClass}">
          <td>${t.Date}</td>
          <td><b>${t._type}</b></td>
          <td>${accDisplay}</td>
          <td>${t.Product || '-'}</td>
          <td>${t.Quantity || '-'}</td>
          <td style="font-weight:800">‚Çπ${parseFloat(t.Amount).toLocaleString()}</td>
          <td>
             <small><b>F:</b> ${t.From || '-'}</small> | 
             <small><b>B:</b> ${t.By || '-'}</small> | 
             <small><b>4:</b> ${t.For || '-'}</small>
          </td>
          <td><button class="btn-del-sm" onclick="deleteTx(${t.id})">√ó</button></td>
        </tr>`;
    }
  });
}

function refreshUI() {
  const accOpts = CLOUD_DATA.accounts.map(a=>`<option value="${a}">${a}</option>`).join('');
  document.getElementById('accList').innerHTML = CLOUD_DATA.accounts.map((a,i)=>`<div class="config-item">${a}<button class="btn-del-sm" onclick="deleteItem('accounts',${i})">√ó</button></div>`).join('');
  
  document.getElementById('accSelect').innerHTML = accOpts; 
  document.getElementById('accFrom').innerHTML = accOpts; 
  document.getElementById('accTo').innerHTML = accOpts;
  
  updateSuggestions(); // Update dropdown with latest product names
  renderWallets(); 
  renderHistory();
}

async function addItem(k, i) { const v=document.getElementById(i).value; if(!v)return; CLOUD_DATA[k].push(v); await sync(k, CLOUD_DATA[k]); document.getElementById(i).value=''; refreshUI(); }
async function deleteItem(k, idx) { if(confirm("Delete Wallet?")) { CLOUD_DATA[k].splice(idx,1); await sync(k, CLOUD_DATA[k]); refreshUI(); } }
async function deleteTx(id) { if(confirm("Delete Record?")) { CLOUD_DATA.txs=CLOUD_DATA.txs.filter(t=>t.id!==id); await sync('txs',CLOUD_DATA.txs); refreshUI(); } }

function updateCharts(m,c,d) {
  const l=Object.keys(m).sort();
  if(charts.bar)charts.bar.destroy(); 
  charts.bar=new Chart(document.getElementById('barChart'),{type:'bar',data:{labels:l,datasets:[{label:'In',data:l.map(x=>m[x].c),backgroundColor:'#10b981'},{label:'Out',data:l.map(x=>m[x].d),backgroundColor:'#ef4444'}]},options:{maintainAspectRatio:false}});
  
  if(charts.pie)charts.pie.destroy(); 
  charts.pie=new Chart(document.getElementById('pieChart'),{type:'doughnut',data:{labels:['In','Out'],datasets:[{data:[c,d],backgroundColor:['#10b981','#ef4444']}]},options:{maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}}});
  
  if(charts.growth)charts.growth.destroy(); 
  charts.growth=new Chart(document.getElementById('growthChart'),{type:'line',data:{labels:l,datasets:[{label:'Savings',data:l.map(x=>m[x].c-m[x].d),borderColor:'#2563eb',tension:0.3, fill:true, backgroundColor:'rgba(37,99,235,0.1)'}]},options:{maintainAspectRatio:false}});
}

init();
</script>
</body>
</html>

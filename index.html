<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ultimate Finance Dashboard Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --primary: #2563eb; 
    --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --border: #e2e8f0; --radius: 12px;
  }
  body { margin:0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 15px; }
  .app { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 300px 1fr 350px; gap: 20px; display:none; }
  
  /* LEFT SIDEBAR: Master Settings Alignment Fix */
  aside .card { height: 92vh; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
  .config-section { margin-bottom: 25px; }
  .config-section p { margin: 0 0 10px 0; font-size: 14px; font-weight: 700; color: #64748b; border-bottom: 2px solid var(--bg); padding-bottom: 5px; }
  
  .config-item { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 8px 12px; background: #f8fafc; border-radius: 8px; 
    margin-bottom: 8px; font-size: 13px; border: 1px solid var(--border);
  }
  .btn-del-sm { 
    background: #fee2e2; color: #ef4444; border: none; width: 22px; height: 22px; 
    border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;
  }
  .btn-del-sm:hover { background: #ef4444; color: white; }

  /* Runway Widget */
  .runway-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; }
  .runway-val { font-size: 32px; font-weight: 800; color: #fbbf24; margin: 5px 0; }
  .runway-bar-bg { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px; }
  .runway-bar-fill { height: 100%; background: #fbbf24; border-radius: 10px; transition: 1s; width: 0%; }

  /* Main & Right UI */
  #walletGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .w-card { background: var(--card); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  .w-val { font-size: 18px; font-weight: 800; color: var(--primary); }
  .card { background: var(--card); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
  
  input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px; font-size: 13px; }
  .btn { cursor: pointer; padding: 10px; border-radius: 8px; border: none; font-weight: 700; width: 100%; }
  .btn-save { background: var(--success); color: white; font-size: 16px; margin-top: 10px; }
  
  /* History Rows */
  .row-credit { border-left: 5px solid var(--success); background: #f0fdf4 !important; }
  .row-debit { border-left: 5px solid var(--danger); background: #fef2f2 !important; }
  .row-transfer { border-left: 5px solid var(--warning); background: #fffbeb !important; }

  /* Dynamic Fields UI */
  .field-row { background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px dashed #cbd5e1; margin-bottom: 8px; position: relative; }
  .field-del { position: absolute; right: 10px; top: 8px; color: var(--danger); cursor: pointer; font-size: 10px; font-weight: bold; }

  #loader { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; }
  td { padding: 12px; border-bottom: 1px solid var(--border); }
</style>
</head>
<body>

<div id="loader">üöÄ Powering Up Your Financial Brain...</div>

<div class="app" id="mainApp">
  <aside>
    <div class="card">
      <h2 style="color:var(--primary); margin:0 0 20px 0; font-size: 18px;">‚öôÔ∏è Master Settings</h2>
      
      <div class="config-section">
        <p>1. WALLETS (ACCOUNTS)</p>
        <div id="accList"></div>
        <input id="newAccName" placeholder="Bank or Cash Name">
        <button class="btn" style="background:var(--primary); color:white" onclick="addItem('accounts', 'newAccName')">+ Add Wallet</button>
      </div>

      <div class="config-section">
        <p>2. CATEGORIES</p>
        <div id="catList"></div>
        <input id="newCatName" placeholder="Salary, Rent, etc.">
        <button class="btn" style="background:var(--primary); color:white" onclick="addItem('categories', 'newCatName')">+ Add Category</button>
      </div>

      <div class="config-section">
        <p>3. FORM FIELDS</p>
        <div id="fieldList"></div>
        <input id="newFieldName" placeholder="Field Name (e.g. Note)">
        <select id="newFieldType">
          <option value="text">Text Box</option>
          <option value="number">Number</option>
          <option value="date">Date Picker</option>
        </select>
        <button class="btn" style="background:var(--primary); color:white" onclick="addField()">+ Create Field</button>
      </div>
    </div>
  </aside>

  <div class="main">
    <div class="runway-card">
      <div style="font-size: 12px; opacity: 0.8; letter-spacing: 1px;">WEALTH RUNWAY (SURVIVAL METER)</div>
      <div class="runway-val" id="runwayValue">Calculating...</div>
      <div id="runwayDetail" style="font-size: 11px; opacity: 0.7;">Add more data for accurate prediction</div>
      <div class="runway-bar-bg"><div class="runway-bar-fill" id="runwayBar"></div></div>
    </div>

    <div id="walletGrid"></div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <div class="card" style="height: 200px; margin:0;"><canvas id="barChart"></canvas></div>
      <div class="card" style="height: 200px; margin:0;"><canvas id="pieChart"></canvas></div>
      <div class="card" style="height: 200px; margin:0;"><canvas id="growthChart"></canvas></div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>Transaction History</h3>
        <input id="searchInp" placeholder="üîç Search any record..." oninput="renderHistory()" style="width:250px; margin:0; border-color:var(--primary)">
      </div>
      <div style="overflow-x:auto">
        <table><thead id="tableHead"></thead><tbody id="txBody"></tbody></table>
      </div>
    </div>
  </div>

  <div class="right-col">
    <div class="card">
      <h3>Add New Entry</h3>
      
      <label><b>Type</b></label>
      <select id="txType" onchange="toggleForm()">
        <option value="Credit">‚ûï CREDIT</option>
        <option value="Debit">‚ûñ DEBIT</option>
        <option value="Transfer">üîÑ TRANSFER</option>
      </select>

      <div id="normalAcc">
        <label><b>Wallet</b></label>
        <select id="accSelect"></select>
      </div>

      <div id="transferAcc" style="display:none; background:#fffbeb; padding:10px; border-radius:8px;">
        <label><b>From Account</b></label>
        <select id="accFrom"></select>
        <label><b>To Account</b></label>
        <select id="accTo"></select>
      </div>

      <div id="catDiv">
        <label><b>Category</b></label>
        <select id="catSelect"></select>
      </div>

      <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
      
      <label><b>Choose Fields to Fill</b></label>
      <select id="fieldSelector" onchange="attachField()"></select>
      
      <div id="dynamicFields"></div>

      <button class="btn btn-save" onclick="saveTransaction()">Save Record</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwjwSeS7svH3Rz_bQ6kfTrvw3oJIgGOy2m_saj_0TmoU6zkSUpk7mZI60aPsYtwmAIO/exec"; 
let CLOUD_DATA = { accounts:[], categories:[], fields:[], txs:[] };
let activeFields = new Set();
let charts = { bar: null, pie: null, growth: null };

async function init() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    for(let k in data) { try { CLOUD_DATA[k] = JSON.parse(data[k]); } catch(e) { CLOUD_DATA[k] = data[k]; } }
    
    // Default config if first time
    if(!CLOUD_DATA.fields || CLOUD_DATA.fields.length === 0) {
      CLOUD_DATA.fields = [{name:'Date', type:'date'}, {name:'Amount', type:'number'}, {name:'Note', type:'text'}];
      CLOUD_DATA.accounts = ['HDFC Bank', 'Cash'];
      CLOUD_DATA.categories = ['Salary', 'Grocery', 'Investment'];
    }
    
    refreshUI();
    document.getElementById('loader').style.display = 'none';
    document.getElementById('mainApp').style.display = 'grid';
  } catch(e) { alert("Check your API URL!"); }
}

async function sync(key, value) {
  CLOUD_DATA[key] = value;
  await fetch(API_URL, { method:'POST', body:JSON.stringify({key, data:JSON.stringify(value)}) });
}

function toggleForm() {
  const type = document.getElementById('txType').value;
  document.getElementById('normalAcc').style.display = type==='Transfer'?'none':'block';
  document.getElementById('catDiv').style.display = type==='Transfer'?'none':'block';
  document.getElementById('transferAcc').style.display = type==='Transfer'?'block':'none';
}

function attachField() {
  const name = document.getElementById('fieldSelector').value;
  if(!name || activeFields.has(name)) return;
  activeFields.add(name);
  const fObj = CLOUD_DATA.fields.find(f => f.name === name);
  const div = document.createElement('div');
  div.className = 'field-row';
  div.id = `row_${name.replace(/\s/g,'_')}`;
  div.innerHTML = `<span class="field-del" onclick="detachField('${name}')">REMOVE ‚úñ</span><label style="font-size:11px;font-weight:bold">${name}</label>
                   <input type="${fObj.type}" id="input_${name.replace(/\s/g,'_')}">`;
  document.getElementById('dynamicFields').appendChild(div);
  document.getElementById('fieldSelector').value = "";
}

function detachField(n) { activeFields.delete(n); document.getElementById(`row_${n.replace(/\s/g,'_')}`).remove(); }

async function saveTransaction() {
  const type = document.getElementById('txType').value;
  let entry = { id: Date.now(), _type: type };
  
  if(type==='Transfer') {
    entry._accFrom = document.getElementById('accFrom').value;
    entry._accTo = document.getElementById('accTo').value;
    entry._cat = "Internal Transfer";
    if(entry._accFrom === entry._accTo) return alert("Accounts can't be same!");
  } else {
    entry._acc = document.getElementById('accSelect').value;
    entry._cat = document.getElementById('catSelect').value;
  }

  activeFields.forEach(f => {
    entry[f] = document.getElementById(`input_${f.replace(/\s/g,'_')}`).value;
  });

  if(!entry.Amount) return alert("Amount field is mandatory!");

  CLOUD_DATA.txs.unshift(entry);
  await sync('txs', CLOUD_DATA.txs);
  
  document.getElementById('dynamicFields').innerHTML = '';
  activeFields.clear();
  refreshUI();
}

function updateRunway(netWorth, txs) {
  const debits = txs.filter(t => t._type === 'Debit' && t.Amount);
  if (debits.length < 2 || netWorth <= 0) {
    document.getElementById('runwayValue').innerText = "Analyzing...";
    return;
  }
  const totalD = debits.reduce((s, t) => s + parseFloat(t.Amount), 0);
  const days = Math.max(1, (new Date(debits[0].Date) - new Date(debits[debits.length-1].Date)) / 86400000);
  const daily = totalD / days;
  const survivalDays = Math.round(netWorth / daily);
  
  const val = document.getElementById('runwayValue');
  const bar = document.getElementById('runwayBar');
  
  if(survivalDays > 365) { val.innerText = (survivalDays/365).toFixed(1) + " Years"; bar.style.backgroundColor = "#10b981"; bar.style.width="100%"; }
  else if(survivalDays > 30) { val.innerText = (survivalDays/30).toFixed(1) + " Months"; bar.style.backgroundColor = "#fbbf24"; bar.style.width="60%"; }
  else { val.innerText = survivalDays + " Days"; bar.style.backgroundColor = "#ef4444"; bar.style.width="20%"; }
  
  document.getElementById('runwayDetail').innerText = `Monthly Burn: ‚Çπ${Math.round(daily*30)} | Net Worth: ‚Çπ${netWorth}`;
}

function renderWallets() {
  const grid = document.getElementById('walletGrid'); grid.innerHTML = '';
  let bals = {}; let tC=0, tD=0, net=0, monthMap={};
  CLOUD_DATA.accounts.forEach(a => bals[a] = 0);

  CLOUD_DATA.txs.forEach(t => {
    const amt = parseFloat(t.Amount) || 0;
    const m = (t.Date || '2025-01').slice(0,7);
    if(!monthMap[m]) monthMap[m] = {c:0, d:0};
    if(t._type==='Credit'){ bals[t._acc]+=amt; tC+=amt; monthMap[m].c+=amt; }
    else if(t._type==='Debit'){ bals[t._acc]-=amt; tD+=amt; monthMap[m].d+=amt; }
    else if(t._type==='Transfer'){ bals[t._accFrom]-=amt; bals[t._accTo]+=amt; }
  });

  for(let a in bals) {
    net += bals[a];
    grid.innerHTML += `<div class="w-card"><div style="font-size:10px;font-weight:700;color:#64748b">${a}</div><div class="w-val">‚Çπ${bals[a].toLocaleString()}</div></div>`;
  }
  updateRunway(net, CLOUD_DATA.txs);
  updateCharts(monthMap, tC, tD);
}

function renderHistory() {
  const search = document.getElementById('searchInp').value.toLowerCase();
  const allFields = CLOUD_DATA.fields.map(f=>f.name);
  document.getElementById('tableHead').innerHTML = `<tr><th>Type</th><th>Account</th><th>Category</th>${allFields.map(f=>`<th>${f}</th>`).join('')}<th>Action</th></tr>`;
  const body = document.getElementById('txBody'); body.innerHTML = '';
  CLOUD_DATA.txs.forEach(t => {
    if(JSON.stringify(t).toLowerCase().includes(search)) {
      const rowClass = t._type==='Credit'?'row-credit':(t._type==='Debit'?'row-debit':'row-transfer');
      body.innerHTML += `<tr class="${rowClass}">
        <td style="font-weight:bold">${t._type}</td>
        <td>${t._type==='Transfer'?t._accFrom+'‚ûî'+t._accTo:t._acc}</td>
        <td>${t._cat}</td>
        ${allFields.map(f=>`<td>${t[f]||'-'}</td>`).join('')}
        <td><button class="btn-del-sm" onclick="deleteTx(${t.id})">√ó</button></td></tr>`;
    }
  });
}

function refreshUI() {
  const accOpts = CLOUD_DATA.accounts.map(a=>`<option value="${a}">${a}</option>`).join('');
  document.getElementById('accList').innerHTML = CLOUD_DATA.accounts.map((a,i)=>`<div class="config-item">${a}<button class="btn-del-sm" onclick="deleteItem('accounts',${i})">√ó</button></div>`).join('');
  document.getElementById('catList').innerHTML = CLOUD_DATA.categories.map((c,i)=>`<div class="config-item">${c}<button class="btn-del-sm" onclick="deleteItem('categories',${i})">√ó</button></div>`).join('');
  document.getElementById('fieldList').innerHTML = CLOUD_DATA.fields.map((f,i)=>`<div class="config-item">${f.name}<button class="btn-del-sm" onclick="deleteItem('fields',${i})">√ó</button></div>`).join('');
  document.getElementById('accSelect').innerHTML = accOpts;
  document.getElementById('accFrom').innerHTML = accOpts;
  document.getElementById('accTo').innerHTML = accOpts;
  document.getElementById('catSelect').innerHTML = CLOUD_DATA.categories.map(c=>`<option value="${c}">${c}</option>`).join('');
  document.getElementById('fieldSelector').innerHTML = '<option value="">-- Click to add Field --</option>' + CLOUD_DATA.fields.map(f=>`<option value="${f.name}">${f.name}</option>`).join('');
  renderWallets();
  renderHistory();
}

async function addItem(k, i) { const v=document.getElementById(i).value; if(!v)return; CLOUD_DATA[k].push(v); await sync(k, CLOUD_DATA[k]); document.getElementById(i).value=''; refreshUI(); }
async function deleteItem(k, idx) { if(confirm("Delete?")) { CLOUD_DATA[k].splice(idx,1); await sync(k, CLOUD_DATA[k]); refreshUI(); } }
async function addField() { const n=document.getElementById('newFieldName').value; const t=document.getElementById('newFieldType').value; if(!n)return; CLOUD_DATA.fields.push({name:n,type:t}); await sync('fields',CLOUD_DATA.fields); document.getElementById('newFieldName').value=''; refreshUI(); }
async function deleteTx(id) { if(confirm("Delete Record?")) { CLOUD_DATA.txs=CLOUD_DATA.txs.filter(t=>t.id!==id); await sync('txs',CLOUD_DATA.txs); refreshUI(); } }

function updateCharts(m,c,d) {
  const l=Object.keys(m).sort();
  if(charts.bar)charts.bar.destroy(); charts.bar=new Chart(document.getElementById('barChart'),{type:'bar',data:{labels:l,datasets:[{label:'Credit',data:l.map(x=>m[x].c),backgroundColor:'#10b981'},{label:'Debit',data:l.map(x=>m[x].d),backgroundColor:'#ef4444'}]},options:{maintainAspectRatio:false}});
  if(charts.pie)charts.pie.destroy(); charts.pie=new Chart(document.getElementById('pieChart'),{type:'doughnut',data:{labels:['Credit','Debit'],datasets:[{data:[c,d],backgroundColor:['#10b981','#ef4444']}]},options:{maintainAspectRatio:false}});
  if(charts.growth)charts.growth.destroy(); charts.growth=new Chart(document.getElementById('growthChart'),{type:'line',data:{labels:l,datasets:[{label:'Savings',data:l.map(x=>m[x].c-m[x].d),borderColor:'#2563eb',tension:0.3}]},options:{maintainAspectRatio:false}});
}

init();
</script>
</body>
</html>

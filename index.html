<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cloud Finance Dashboard - Fixed</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #64748b;
    --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #ca8a04;
    --radius: 12px; --border: #e2e8f0;
  }
  body { margin:0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
  .app { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 240px 1fr 340px; gap: 20px; display:none; }
  .card { background: var(--card); border-radius: var(--radius); padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 20px; }
  .top-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
  .stat-card { background: var(--card); padding: 14px; border-radius: var(--radius); border: 1px solid var(--border); }
  .stat-val { font-size: 22px; font-weight: 700; margin-top: 5px; }
  .field-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 8px; border-radius: 6px; margin-bottom: 6px; border: 1px solid var(--border); font-size: 13px; }
  .btn-del-field { color: var(--danger); cursor: pointer; border: none; background: none; font-size: 18px; }
  input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 12px; box-sizing: border-box; }
  button { cursor: pointer; padding: 10px; border-radius: 6px; border: none; font-weight: 600; width: 100%; transition: 0.2s; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-muted { background: #f1f5f9; color: var(--text); border: 1px solid var(--border); }
  .btn-danger-outline { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; margin-top: 10px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--border); }
  td { padding: 12px; border-bottom: 1px solid var(--border); }
  #loader { position: fixed; inset: 0; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: 600; }
  #savingToast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 10px 20px; border-radius: 30px; display: none; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  @media (max-width: 1000px) { .app { grid-template-columns: 1fr; } aside { display:none; } }
</style>
</head>
<body>

<div id="loader">üîÑ Syncing with Cloud...</div>
<div id="savingToast">‚òÅÔ∏è Saving Structure...</div>

<div class="app" id="mainApp">
  <aside>
    <div class="card" style="text-align: center;">
      <h2 style="color: var(--primary);">Finance App</h2>
      <button class="btn-muted" onclick="location.reload()">üîÑ Refresh Page</button>
    </div>
  </aside>

  <div class="main">
    <div class="top-cards">
      <div class="stat-card"><div style="font-size:12px; color:var(--muted)">INCOME</div><div class="stat-val" id="st-inc" style="color:var(--success)">‚Çπ0</div></div>
      <div class="stat-card"><div style="font-size:12px; color:var(--muted)">EXPENSE</div><div class="stat-val" id="st-exp" style="color:var(--danger)">‚Çπ0</div></div>
      <div class="stat-card"><div style="font-size:12px; color:var(--muted)">BALANCE</div><div class="stat-val" id="st-bal">‚Çπ0</div></div>
      <div class="stat-card"><div style="font-size:12px; color:var(--muted)">LOANS</div><div class="stat-val" id="st-loan" style="color:var(--warning)">‚Çπ0</div></div>
    </div>

    <div class="card" style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
      <div style="height:250px"><canvas id="barChart"></canvas></div>
      <div style="height:250px;"><canvas id="pieChart"></canvas></div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>History</h3>
        <input id="searchInp" placeholder="Search..." oninput="refreshDashboard()" style="width:150px; margin:0">
      </div>
      <table>
        <thead><tr><th>Date</th><th>Type</th><th>Details</th><th>Amount</th><th>Action</th></tr></thead>
        <tbody id="txBody"></tbody>
      </table>
    </div>
  </div>

  <div class="right-col">
    <div class="card">
      <h3>Add New Entry</h3>
      <select id="typeSelect" onchange="renderDynamicFields()"></select>
      <div id="dynamicArea"></div>
      <button class="btn-primary" onclick="saveTransaction()">Save Transaction</button>
    </div>

    <div class="card">
      <h3>Configuration</h3>
      <select id="configTypeSel" onchange="updateFieldManager()">
        <option value="new">+ New Type</option>
      </select>
      <div id="fieldManagerArea" style="display:none; margin-top:15px;">
        <div id="fieldList"></div>
        <div style="background:#f8fafc; padding:10px; border-radius:8px; border: 1px dashed var(--border); margin-top:10px;">
          <input id="newFieldLabel" placeholder="Field Name">
          <select id="newFieldType">
            <option value="text">Text</option><option value="number">Number</option><option value="date">Date</option>
          </select>
          <button class="btn-primary" onclick="addNewField()">+ Add Field</button>
        </div>
        <button class="btn-danger-outline" onclick="deleteExistingType()">üóë Delete Type</button>
      </div>
      <div id="newTypeArea" style="margin-top:10px;">
        <input id="newTypeName" placeholder="New Type Name">
        <button class="btn-primary" onclick="createNewType()">Create Type</button>
      </div>
    </div>
  </div>
</div>

<script>
// üî¥ APNA NEW DEPLOYMENT URL YAHAN DALEIN
const API_URL = "https://script.google.com/macros/s/AKfycbwjwSeS7svH3Rz_bQ6kfTrvw3oJIgGOy2m_saj_0TmoU6zkSUpk7mZI60aPsYtwmAIO/exec"; 

let CLOUD_DATA = {}; 
let charts = { bar: null, pie: null };

async function init() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    for(let k in data) { 
      try { CLOUD_DATA[k] = JSON.parse(data[k]); } 
      catch(e) { CLOUD_DATA[k] = data[k]; } 
    }
    if(!CLOUD_DATA.saved_types) { 
      CLOUD_DATA = { saved_types:['Income','Expense'], txs:[], form_Income:[{label:'Date',type:'date'},{label:'Amount',type:'number'}], form_Expense:[{label:'Date',type:'date'},{label:'Amount',type:'number'}] }; 
    }
    setupUI();
    document.getElementById('loader').style.display = 'none';
    document.getElementById('mainApp').style.display = 'grid';
  } catch(e) { alert("Data load nahi ho paya. URL check karein."); }
}

// ‚òÅÔ∏è SYNC FUNCTION WITH AWAIT (VERY IMPORTANT)
async function sync(key, value) {
  CLOUD_DATA[key] = value;
  document.getElementById('savingToast').style.display = 'block';
  try { 
    await fetch(API_URL, { 
      method:'POST', 
      body:JSON.stringify({key, data:JSON.stringify(value)}) 
    }); 
  } 
  catch(e) { console.error("Sync Error:", e); } 
  finally { setTimeout(() => document.getElementById('savingToast').style.display = 'none', 800); }
}

function setupUI() { populateSelects(); refreshDashboard(); }

function populateSelects() {
  const types = CLOUD_DATA.saved_types || [];
  const mainSel = document.getElementById('typeSelect');
  const confSel = document.getElementById('configTypeSel');
  mainSel.innerHTML = '<option value="">-- Select Category --</option>';
  confSel.innerHTML = '<option value="new">+ New Type</option>';
  types.forEach(t => {
    mainSel.innerHTML += `<option value="${t}">${t}</option>`;
    confSel.innerHTML += `<option value="${t}">${t}</option>`;
  });
}

function updateFieldManager() {
  const selectedType = document.getElementById('configTypeSel').value;
  const fieldArea = document.getElementById('fieldManagerArea');
  const newTypeArea = document.getElementById('newTypeArea');
  const list = document.getElementById('fieldList');
  if(selectedType === 'new') { fieldArea.style.display = 'none'; newTypeArea.style.display = 'block'; } 
  else {
    fieldArea.style.display = 'block'; newTypeArea.style.display = 'none';
    list.innerHTML = '';
    const fields = CLOUD_DATA['form_' + selectedType] || [];
    fields.forEach((f, idx) => {
      list.innerHTML += `<div class="field-item"><span>${f.label} (${f.type})</span><button class="btn-del-field" onclick="deleteField('${selectedType}', ${idx})">√ó</button></div>`;
    });
  }
}

async function deleteField(type, idx) {
  if(!confirm("Field delete karein?")) return;
  const key = 'form_' + type;
  CLOUD_DATA[key].splice(idx, 1);
  await sync(key, CLOUD_DATA[key]);
  updateFieldManager();
  if(document.getElementById('typeSelect').value === type) renderDynamicFields();
}

async function addNewField() {
  const type = document.getElementById('configTypeSel').value;
  const label = document.getElementById('newFieldLabel').value.trim();
  const fType = document.getElementById('newFieldType').value;
  if(!label) return;
  const key = 'form_' + type;
  if(!CLOUD_DATA[key]) CLOUD_DATA[key] = [];
  CLOUD_DATA[key].push({ label, type: fType });
  await sync(key, CLOUD_DATA[key]);
  document.getElementById('newFieldLabel').value = '';
  updateFieldManager();
}

async function createNewType() {
  const name = document.getElementById('newTypeName').value.trim();
  if(!name) return;
  if(CLOUD_DATA.saved_types.includes(name)) return alert("Already exists");
  CLOUD_DATA.saved_types.push(name);
  await sync('saved_types', CLOUD_DATA.saved_types);
  await sync('form_' + name, [{label:'Date', type:'date'}, {label:'Amount', type:'number'}]);
  document.getElementById('newTypeName').value = '';
  populateSelects();
  document.getElementById('configTypeSel').value = name;
  updateFieldManager();
}

async function deleteExistingType() {
  const type = document.getElementById('configTypeSel').value;
  if(confirm(`"${type}" ko delete karein?`)) {
    CLOUD_DATA.saved_types = CLOUD_DATA.saved_types.filter(t => t !== type);
    await sync('saved_types', CLOUD_DATA.saved_types);
    populateSelects(); updateFieldManager();
  }
}

function renderDynamicFields() {
  const type = document.getElementById('typeSelect').value;
  const area = document.getElementById('dynamicArea');
  area.innerHTML = ''; if(!type) return;
  const fields = CLOUD_DATA['form_' + type] || [];
  fields.forEach(f => {
    const safe = f.label.replace(/\s/g, '_');
    area.innerHTML += `<label style="font-size:12px; font-weight:600;">${f.label}</label><input id="inp_${safe}" type="${f.type}">`;
  });
}

async function saveTransaction() {
  const type = document.getElementById('typeSelect').value;
  if(!type) return alert("Category select karein");
  const fieldsDef = CLOUD_DATA['form_' + type] || [];
  let entryData = {};
  for(let f of fieldsDef) {
    const safe = f.label.replace(/\s/g, '_');
    const val = document.getElementById('inp_' + safe).value;
    const lower = f.label.toLowerCase();
    if((lower==='date' || lower==='amount') && !val) return alert(f.label + " zaroori hai");
    entryData[f.label] = (f.type === 'number') ? parseFloat(val) : val;
  }
  const txs = CLOUD_DATA.txs || [];
  txs.unshift({ id: Date.now(), type, ...entryData });
  await sync('txs', txs);
  refreshDashboard(); renderDynamicFields(); alert("Saved!");
}

function refreshDashboard() {
  const txs = CLOUD_DATA.txs || [];
  let inc=0, exp=0, loans=0, monthMap={};
  const search = document.getElementById('searchInp').value.toLowerCase();
  const tbody = document.getElementById('txBody'); tbody.innerHTML = '';

  txs.forEach(t => {
    // FIX: Normalize keys to lowercase for robust mapping
    const norm = {}; Object.keys(t).forEach(k => norm[k.toLowerCase()] = t[k]);
    const amt = parseFloat(norm.amount) || 0;
    const typeStr = (norm.type || "").toLowerCase();
    const dateStr = norm.date || "-";
    
    if(typeStr.includes('income')) inc += amt;
    else if(typeStr.includes('expense')) exp += amt;
    if(typeStr.includes('loan')) loans += amt;
    
    const mKey = dateStr !== "-" ? dateStr.slice(0, 7) : 'Other';
    if(!monthMap[mKey]) monthMap[mKey] = {i:0, e:0};
    if(typeStr.includes('income')) monthMap[mKey].i += amt;
    else if(typeStr.includes('expense')) monthMap[mKey].e += amt;
    
    if(JSON.stringify(t).toLowerCase().includes(search)) {
      let details = [];
      Object.keys(t).forEach(k => {
        if(!['id','type','date','amount'].includes(k.toLowerCase())) details.push(`${k}:${t[k]}`);
      });
      tbody.innerHTML += `<tr><td>${dateStr}</td><td>${t.type}</td><td style="font-size:11px; color:var(--muted)">${details.join('|')}</td><td style="font-weight:bold">‚Çπ${amt}</td><td><button onclick="deleteTx(${t.id})" style="color:red; background:none; font-size:11px; width:auto;">Del</button></td></tr>`;
    }
  });
  document.getElementById('st-inc').textContent = '‚Çπ' + inc;
  document.getElementById('st-exp').textContent = '‚Çπ' + exp;
  document.getElementById('st-bal').textContent = '‚Çπ' + (inc - exp);
  document.getElementById('st-loan').textContent = '‚Çπ' + loans;
  renderCharts(monthMap, inc, exp);
}

async function deleteTx(id) {
  if(!confirm("Record delete karein?")) return;
  CLOUD_DATA.txs = CLOUD_DATA.txs.filter(t => t.id !== id);
  await sync('txs', CLOUD_DATA.txs);
  refreshDashboard();
}

function renderCharts(monthly, tInc, tExp) {
  const labels = Object.keys(monthly).sort();
  if(charts.bar) charts.bar.destroy();
  charts.bar = new Chart(document.getElementById('barChart'), {
    type:'bar',
    data: { labels, datasets: [ { label:'Inc', data: labels.map(l=>monthly[l].i), backgroundColor:'#16a34a' }, { label:'Exp', data: labels.map(l=>monthly[l].e), backgroundColor:'#dc2626' } ] },
    options: { responsive:true, maintainAspectRatio:false }
  });
  if(charts.pie) charts.pie.destroy();
  charts.pie = new Chart(document.getElementById('pieChart'), {
    type:'doughnut',
    data: { labels:['Inc','Exp'], datasets: [{ data:[tInc, tExp], backgroundColor:['#16a34a','#dc2626'] }] },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

init();
</script>
</body>
</html>
